自己写的web服务大多只提供了静态文件分发的功能，在高并发时我们需要高性能的静态文件分发，还需要反向代理、负载均衡等，这就是nginx的作用

docker的管理机制非常适合安装测试软件，所以决定使用docker学习nginx

    docker run -p 127.0.0.2:80:80 --name mynginx --rm -d nginx

注意nginx默认cmd是启动nginx，我们不要覆盖他，可以再次进入的时候启动bash
    
    docker exec -it mynginx bash

在 /usr/share/nginx/html/index.html 可以看到nginx的欢迎页

实际安装的时候有很多参数，可以指定安装位置或静态文件位置等

先把nginx的html文件和配置文件以及日志映射到本地，再修改配置，否则容器删除后自己的修改都没了

    docker run -d --name mynginx \
    --mount type=bind,source=$PWD/nginx/html,target=/usr/share/nginx/html \
    --mount type=bind,source=$PWD/nginx/conf/nginx.conf,target=/etc/nginx/nginx.conf \
    --mount type=bind,source=$PWD/nginx/log,target=/var/log/nginx \
    -p 127.0.0.1:8080:80 \
    -p 127.0.0.1:4443:443 \
    nginx 


# nginx概览
ngxin主要作用是静态资源的分发、反向代理，提供的功能简单但又多样化，所以操作命令很简单，主要是配置文件复杂

    nginx -s stop       快速关闭Nginx，可能不保存相关信息，并迅速终止web服务。
    nginx -s quit       平稳关闭Nginx，保存相关信息，有安排的结束web服务
    nginx -s reload     因改变了Nginx相关配置，需要重新加载配置而重载。
    nginx -s reopen     重新打开日志文件。
    nginx -c filename   为 Nginx 指定一个配置文件，来代替缺省的。
    nginx -t            不运行，而仅仅测试配置文件。nginx 将检查配置文件的语法的正确性，并尝试打开配置文件中所引用到的文件。
    nginx -v            显示 nginx 的版本。
    nginx -V            显示 nginx 的版本，编译器版本和配置参数。

这些命令也都可以以kill形式发出，如 kill -QUIT nginx主进程号

## work
nginx会先启动的进程称为master，然后他会fork出work进程，master做配置文件加载，维持work存活等管理工作，而work才是真正处理连接的进程

多进程的模式可以避免单进程死亡服务停止，同时热部署时只需要再创建新进程，待旧进程处理完工作后杀死

![](img/1.png)

# 配置文件
他的配置文件一般在 /etc/nginx/，nginx下有两个配置文件，conf.d/default.conf，用来配置不常改变的，整个服务运行时的配置信息，例如监听端口号，另一个是nginx.conf，默认配置文件，主要用来设置http服务等经常改变的配置信息，可以使用nginx -c指定其他配置文件

nginx.conf 主要分为四部分，main全局设置、server主机设置、upstream上游服务器设置、location URL匹配特定位置后的设置 

## 基本配置
```
user  nginx;
worker_processes  4; # work进程，建议设置和核心值相同

error_log  /var/log/nginx/error.log warn; # 日志文件和日志级别
pid        /var/run/nginx.pid; # 存放主进程pid文件的位置


events {
    worker_connections  1024; # 一个work允许同时执行多少连接
}
```

## http配置
```
# 重要，配置http
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # 设置使用的字符集，如果该网站可能有多个字符集，不应该在这里设置，而是在页面meta中设置
    # charset utf-8; 
    
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    # 设置客户端能够上传文件大小
    client_max_body_size 8m;
    
    access_log  /var/log/nginx/access.log  main;
    
    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  90;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
    
    # 服务是最小监听单元    
    server{
        # server_name:listen/location 三者共同决定了分发路径
        listen 80;
        server_name localhost;
        
        location / { # 所有以 / 开头的 uri 都会从下面文件夹里找静态资源,最长匹配
            root  html; # 以 nginx 所在文件夹下的相对路径 
            index index.html; # 默认返回页面
        }

        # 访问路径 localhost:80/test
        # 资源路径 html/data/test 即 root + url
        location /test/ {
            root html/data/;
            index index.html;
        }

        access_log  /var/log/nginx/localhost.access.log;    
    }
}
```

如果多个IP但同一个端口，或者多个域名同一个端口，映射到不同的网站，好像将一台主机的端口重用了，这就是虚拟主机，主要通过 server 配置

也就是说真正映射的分发文件夹由 server_name:listen/location 三者共同决定
