自己写的web服务大多只提供了静态文件分发的功能，在高并发时我们需要高性能的静态文件分发，还需要反向代理、负载均衡等，这就是nginx的作用

docker的管理机制非常适合安装测试软件，所以决定使用docker学习nginx

    docker run -p 127.0.0.2:80:80 --name mynginx --rm -d nginx

注意nginx默认cmd是启动nginx，我们不要覆盖他，可以再次进入的时候启动bash
    
    docker exec -it mynginx bash

在 /usr/share/nginx/html/index.html 可以看到nginx的欢迎页

先把nginx的html文件和配置文件映射到本地，再修改配置，否则容器删除后自己的修改都没了

    docker run -d --name mynginx \
    --mount type=bind,source=$PWD/nginx/html,target=/usr/share/nginx/html \
    --mount type=bind,source=$PWD/nginx/conf,target=/etc/nginx \
    -p 127.0.0.2:80:80 \
    -p 127.0.0.2:443:443 \
    nginx 


ngxin主要作用是静态资源的分发、反向代理，提供的功能简单但又多样化，所以操作命令很简单，主要是配置文件复杂

    nginx -s stop       快速关闭Nginx，可能不保存相关信息，并迅速终止web服务。
    nginx -s quit       平稳关闭Nginx，保存相关信息，有安排的结束web服务。
    nginx -s reload     因改变了Nginx相关配置，需要重新加载配置而重载。
    nginx -s reopen     重新打开日志文件。
    nginx -c filename   为 Nginx 指定一个配置文件，来代替缺省的。
    nginx -t            不运行，而仅仅测试配置文件。nginx 将检查配置文件的语法的正确性，并尝试打开配置文件中所引用到的文件。
    nginx -v            显示 nginx 的版本。
    nginx -V            显示 nginx 的版本，编译器版本和配置参数。

# work
nginx会先启动的进程称为master，然后他会fork出work进程，master做配置文件加载，维持work存活等管理工作，而work才是真正处理连接的进程

多进程的模式可以避免单进程死亡服务停止，同时热部署时只需要再创建新进程，待旧进程处理完工作后杀死

# 配置文件
他的配置文件一般在 /etc/nginx/，nginx下有两个配置文件，conf.d/default.conf，用来配置不常改变的，整个服务运行时的配置信息，例如监听端口号，另一个是nginx.conf，默认配置文件，主要用来设置http服务等经常改变的配置信息，可以使用nginx -c指定其他配置文件

nginx.conf 主要分为四部分，main全局设置、server主机设置、upstream上游服务器设置、location URL匹配特定位置后的设置 

## 基本配置

    user  nginx; # 运行用户
    worker_processes  4; # work进程，建议设置和核心值相同

    error_log  /var/log/nginx/error.log warn; # 日志文件和日志级别
    pid        /var/run/nginx.pid; # 记录当前启动的nginx的进程id


    events {
        worker_connections  1024; # 一个work允许同时处理多少连接
    }

## http配置

    http {
        include       /etc/nginx/mime.types; # 支持发送文件的类型
        default_type  application/octet-stream; 

        # 记录日志的格式
        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log  /var/log/nginx/access.log  main;

        # sendfile指令指定nginx是否调用sendfile函数（zero copy方式）来输出文件，即将文件缓存在内存中
        # 少量静态文件分发应当开启，如果用来下载等应用磁盘IO重负载应用，可设置为off
        sendfile        on; 
        #tcp_nopush     on;

        keepalive_timeout  120;

        #gzip  on;

        include /etc/nginx/conf.d/*.conf;
        
        # http服务上支持若干虚拟主机，每个虚拟主机一个对应的server配置，可以通过监听端口或地址来区分
        server{
            listen 80; # 默认80，小于1024的需要以root启动，可以是 listen *:80、listen 127.0.0.1:80等形式
            # 服务器名，www.example.com 可以正则匹配，通过域名区分能让同一个服务器同一个端口下分发不同文件
            # 可以用域名做端口复用
            server_name localhost; 
            # 对应静态文件的路径，相对路径是以nginx目录为根路径
            root files; 
            charset utf-8;
        }
    }
